{% extends 'user_base.html' %}

{% load static %}
{% load build_extras %}

{% block title %}Downloads for {{ object }}{% endblock %}

{% block head %}
    <!-- Font Awesome -->
    <script src="{% static 'js/solid.min.js' %}"></script>
    <script src="{% static 'js/regular.min.js' %}"></script>
    <script src="{% static 'js/fontawesome.min.js' %}"></script>
{% endblock %}

{% block content %}
    <h1>Downloads for {{ object }}</h1>
    <br>

    {% include 'debug_warning.html' %}

    {% include 'donation_alert.html' %}

    <!-- Build information -->
    <div>
        <p>Device: {{ object.device }}</p>
        <p>Build: {{ object.get_user_friendly_name }}</p>
        <p>Build size: {{ object.get_human_readable_size }}</p>
    </div>

    <!-- Mirrors -->
    <div class="container">
        <table class="table">
            <thead>
            <tr>
                <th scope="col">Server</th>
                <th scope="col">Description</th>
                <th scope="col">Download</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>Main</td>
                <td>Download builds from the main website.</td>
                <td><a href="{{ object.zip_file.url }}"
                       class="btn btn-success btn-sm">
                    <i class="fa fa-file-archive" aria-hidden="true"></i>
                    Download
                </a>
                    <a href="{{ object.md5_file.url }}"
                       class="btn btn-link btn-sm">
                        <i class="fa fa-hashtag" aria-hidden="true"></i>
                        MD5
                    </a>
                </td>
            </tr>

            {% for mirror in object.get_enabled_downloadable_mirrors %}
                <tr>
                    <td>{{ mirror.name }}</td>
                    <td>{{ mirror.description }}</td>
                    <td><a href="{{ mirror.download_url_base|format_download_url:object.zip_file.name }}"
                           class="btn btn-success btn-sm">
                        <i class="fa fa-file-archive" aria-hidden="true"></i>
                        Download
                    </a>
                        <a href="{{ mirror.download_url_base|format_download_url:object.md5_file.name }}"
                           class="btn btn-link btn-sm">
                            <i class="fa fa-hashtag" aria-hidden="true"></i>
                            MD5
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- TODO: Remove JQuery -->

    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Download counter script -->
    <script>
        // Get all download buttons and add event listener
        $(document).ready(function () {
            $('a.btn.btn-success.btn-sm').on('click', function (e) {
                e.preventDefault();
                const downloadURL = $(this).attr("href");

                $.ajax({
                    url: "{% url 'v1_download_build_counter' %}",
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify({
                        file_name: "{{ object.file_name }}",
                        build_id: {{ object.id }}
                    })
                })
                    .always(function () {
                        window.location.href = downloadURL;
                    });
            });
        });
    </script>


{% endblock %}